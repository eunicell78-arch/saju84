<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ì£¼íŒ”ì ë§Œì„¸ë ¥ ê³„ì‚°ê¸° - Four Pillars Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .calendar-type {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .calendar-type label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 10px 20px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .calendar-type input[type="radio"]:checked + label,
        .calendar-type label:has(input[type="radio"]:checked) {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .calendar-type input[type="radio"] {
            margin-right: 8px;
        }

        .date-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .result-section {
            display: none;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .result-section.show {
            display: block;
        }

        .pillars-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            overflow: hidden;
            border-radius: 10px;
        }

        .pillars-table th,
        .pillars-table td {
            padding: 15px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .pillars-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .pillars-table td {
            background: white;
        }

        .pillar-cell {
            font-size: 1.1rem;
        }

        .pillar-chinese {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .pillar-korean {
            font-size: 0.9rem;
            color: #666;
        }

        .element-info {
            margin-top: 5px;
            font-size: 0.85rem;
            color: #888;
        }

        .info-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .info-section h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .info-section ul {
            margin-left: 20px;
        }

        .info-section li {
            margin-bottom: 8px;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error.show {
            display: block;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .content {
                padding: 20px;
            }

            .date-inputs {
                grid-template-columns: 1fr;
            }

            .pillars-table {
                font-size: 0.9rem;
            }

            .pillar-chinese {
                font-size: 1.2rem;
            }
        }

        .leap-month-checkbox {
            margin-top: 10px;
        }

        .leap-month-checkbox label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .leap-month-checkbox input[type="checkbox"] {
            margin-right: 8px;
        }

        .converted-date {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }

        .converted-date strong {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”® ì‚¬ì£¼íŒ”ì ë§Œì„¸ë ¥ ê³„ì‚°ê¸°</h1>
            <p>Four Pillars of Destiny Calculator</p>
        </div>

        <div class="content">
            <div class="error" id="errorMsg"></div>

            <div class="input-section">
                <h2 style="margin-bottom: 20px;">ìƒë…„ì›”ì¼ì‹œ ì…ë ¥</h2>

                <div class="form-group">
                    <div class="calendar-type">
                        <label>
                            <input type="radio" name="calendarType" value="solar" checked>
                            ì–‘ë ¥ (Solar)
                        </label>
                        <label>
                            <input type="radio" name="calendarType" value="lunar">
                            ìŒë ¥ (Lunar)
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>ìƒë…„ì›”ì¼</label>
                    <div class="date-inputs">
                        <div>
                            <input type="number" id="year" placeholder="ë…„ (Year)" min="1900" max="2100">
                        </div>
                        <div>
                            <input type="number" id="month" placeholder="ì›” (Month)" min="1" max="12">
                        </div>
                        <div>
                            <input type="number" id="day" placeholder="ì¼ (Day)" min="1" max="31">
                        </div>
                    </div>
                    <div class="leap-month-checkbox" id="leapMonthDiv" style="display: none;">
                        <label>
                            <input type="checkbox" id="isLeapMonth">
                            ìœ¤ë‹¬ (Leap Month)
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>ì¶œìƒ ì‹œê°„</label>
                    <div class="time-inputs">
                        <div>
                            <input type="number" id="hour" placeholder="ì‹œ (Hour)" min="0" max="23">
                        </div>
                        <div>
                            <input type="number" id="minute" placeholder="ë¶„ (Minute)" min="0" max="59" value="0">
                        </div>
                    </div>
                </div>

                <button class="btn" onclick="calculateSaju()">ì‚¬ì£¼íŒ”ì ê³„ì‚°í•˜ê¸°</button>
            </div>

            <div class="result-section" id="resultSection">
                <h2 style="margin-bottom: 15px;">ğŸ“Š ì‚¬ì£¼íŒ”ì ê²°ê³¼</h2>
                <div id="convertedDate" class="converted-date"></div>
                <table class="pillars-table">
                    <thead>
                        <tr>
                            <th>ì‹œì£¼ (æ™‚æŸ±)<br>Hour Pillar</th>
                            <th>ì¼ì£¼ (æ—¥æŸ±)<br>Day Pillar</th>
                            <th>ì›”ì£¼ (æœˆæŸ±)<br>Month Pillar</th>
                            <th>ì—°ì£¼ (å¹´æŸ±)<br>Year Pillar</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="hourPillar" class="pillar-cell"></td>
                            <td id="dayPillar" class="pillar-cell"></td>
                            <td id="monthPillar" class="pillar-cell"></td>
                            <td id="yearPillar" class="pillar-cell"></td>
                        </tr>
                    </tbody>
                </table>
                <div id="elementInfo" class="info-section"></div>
            </div>

            <div class="info-section">
                <h3>ğŸ“– ì‚¬ìš© ë°©ë²•</h3>
                <ul>
                    <li><strong>ì–‘ë ¥/ìŒë ¥ ì„ íƒ:</strong> ì¶œìƒì¼ì´ ì–‘ë ¥ì´ë©´ 'ì–‘ë ¥', ìŒë ¥ì´ë©´ 'ìŒë ¥'ì„ ì„ íƒí•˜ì„¸ìš”</li>
                    <li><strong>ìƒë…„ì›”ì¼ ì…ë ¥:</strong> 1900ë…„~2100ë…„ ì‚¬ì´ì˜ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”</li>
                    <li><strong>ìœ¤ë‹¬:</strong> ìŒë ¥ ìœ¤ë‹¬ì— íƒœì–´ë‚¬ë‹¤ë©´ 'ìœ¤ë‹¬' ì²´í¬ë°•ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</li>
                    <li><strong>ì‹œê°„ ì…ë ¥:</strong> ì¶œìƒ ì‹œê°„ì„ 24ì‹œê°„ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì˜¤ì „ 5ì‹œ 30ë¶„ â†’ 5ì‹œ 30ë¶„)</li>
                    <li><strong>ìì‹œ(å­æ™‚) ì£¼ì˜:</strong> 23:00~24:00ëŠ” ë‹¤ìŒ ë‚ ì˜ ìì‹œë¡œ ê³„ì‚°ë©ë‹ˆë‹¤</li>
                </ul>

                <h3 style="margin-top: 20px;">ğŸ§ª í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ</h3>
                <ul>
                    <li><strong>1992ë…„ 10ì›” 24ì¼ 05:30 (ì–‘ë ¥)</strong><br>
                    â†’ ì—°ì£¼: å£¬ç”³(ì„ì‹ ), ì›”ì£¼: åºšæˆŒ(ê²½ìˆ ), ì¼ì£¼: ç™¸é…‰(ê³„ìœ ), ì‹œì£¼: ä¹™å¯(ì„ë¬˜)</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const HEAVENLY_STEMS = [
            { ko: 'ê°‘', ch: 'ç”²', element: 'æœ¨(ì–‘ëª©)', pinyin: 'Gab' },
            { ko: 'ì„', ch: 'ä¹™', element: 'æœ¨(ìŒëª©)', pinyin: 'Eul' },
            { ko: 'ë³‘', ch: 'ä¸™', element: 'ç«(ì–‘í™”)', pinyin: 'Byeong' },
            { ko: 'ì •', ch: 'ä¸', element: 'ç«(ìŒí™”)', pinyin: 'Jeong' },
            { ko: 'ë¬´', ch: 'æˆŠ', element: 'åœŸ(ì–‘í† )', pinyin: 'Mu' },
            { ko: 'ê¸°', ch: 'å·±', element: 'åœŸ(ìŒí† )', pinyin: 'Gi' },
            { ko: 'ê²½', ch: 'åºš', element: 'é‡‘(ì–‘ê¸ˆ)', pinyin: 'Gyeong' },
            { ko: 'ì‹ ', ch: 'è¾›', element: 'é‡‘(ìŒê¸ˆ)', pinyin: 'Sin' },
            { ko: 'ì„', ch: 'å£¬', element: 'æ°´(ì–‘ìˆ˜)', pinyin: 'Im' },
            { ko: 'ê³„', ch: 'ç™¸', element: 'æ°´(ìŒìˆ˜)', pinyin: 'Gye' }
        ];

        const EARTHLY_BRANCHES = [
            { ko: 'ì', ch: 'å­', element: 'æ°´', pinyin: 'Ja', animal: 'ì¥(é¼ )' },
            { ko: 'ì¶•', ch: 'ä¸‘', element: 'åœŸ', pinyin: 'Chuk', animal: 'ì†Œ(ç‰›)' },
            { ko: 'ì¸', ch: 'å¯…', element: 'æœ¨', pinyin: 'In', animal: 'í˜¸ë‘ì´(è™)' },
            { ko: 'ë¬˜', ch: 'å¯', element: 'æœ¨', pinyin: 'Myo', animal: 'í† ë¼(å…”)' },
            { ko: 'ì§„', ch: 'è¾°', element: 'åœŸ', pinyin: 'Jin', animal: 'ìš©(é¾)' },
            { ko: 'ì‚¬', ch: 'å·³', element: 'ç«', pinyin: 'Sa', animal: 'ë±€(è›‡)' },
            { ko: 'ì˜¤', ch: 'åˆ', element: 'ç«', pinyin: 'O', animal: 'ë§(é¦¬)' },
            { ko: 'ë¯¸', ch: 'æœª', element: 'åœŸ', pinyin: 'Mi', animal: 'ì–‘(ç¾Š)' },
            { ko: 'ì‹ ', ch: 'ç”³', element: 'é‡‘', pinyin: 'Sin', animal: 'ì›ìˆ­ì´(çŒ´)' },
            { ko: 'ìœ ', ch: 'é…‰', element: 'é‡‘', pinyin: 'Yu', animal: 'ë‹­(é›)' },
            { ko: 'ìˆ ', ch: 'æˆŒ', element: 'åœŸ', pinyin: 'Sul', animal: 'ê°œ(çŠ¬)' },
            { ko: 'í•´', ch: 'äº¥', element: 'æ°´', pinyin: 'Hae', animal: 'ë¼ì§€(è±¬)' }
        ];

        // Lunar calendar data for 1900-2100 (Korean Astronomy Research Institute standard)
        // Format: [year, lunar_month_days, leap_month]
        // lunar_month_days encoded as bit flags (1=30days, 0=29days)
        // Reference: Based on Korean lunar calendar standards
        const LUNAR_DATA = [
            [1900,0x04bd8,0], [1901,0x04ae0,0], [1902,0x0a570,5], [1903,0x054d5,0], [1904,0x0d260,0],
            [1905,0x0d950,0], [1906,0x16554,4], [1907,0x056a0,0], [1908,0x09ad0,0], [1909,0x055d2,2],
            [1910,0x04ae0,0], [1911,0x0a5b6,0], [1912,0x0a4d0,0], [1913,0x0d250,8], [1914,0x1d255,0],
            [1915,0x0b540,0], [1916,0x0d6a0,6], [1917,0x0ada2,0], [1918,0x095b0,0], [1919,0x14977,0],
            [1920,0x04970,0], [1921,0x0a4b0,0], [1922,0x0b4b5,4], [1923,0x06a50,0], [1924,0x06d40,0],
            [1925,0x1ab54,2], [1926,0x02b60,0], [1927,0x09570,7], [1928,0x052f2,0], [1929,0x04970,0],
            [1930,0x06566,0], [1931,0x0d4a0,0], [1932,0x0ea50,5], [1933,0x06e95,0], [1934,0x05ad0,0],
            [1935,0x02b60,3], [1936,0x186e3,0], [1937,0x092e0,0], [1938,0x1c8d7,7], [1939,0x0c950,0],
            [1940,0x0d4a0,0], [1941,0x1d8a6,0], [1942,0x0b550,0], [1943,0x056a0,6], [1944,0x1a5b4,0],
            [1945,0x025d0,0], [1946,0x092d0,2], [1947,0x0d2b2,0], [1948,0x0a950,0], [1949,0x0b557,7],
            [1950,0x06ca0,0], [1951,0x0b550,0], [1952,0x15355,5], [1953,0x04da0,0], [1954,0x0a5b0,3],
            [1955,0x14573,0], [1956,0x052b0,0], [1957,0x0a9a8,8], [1958,0x0e950,0], [1959,0x06aa0,0],
            [1960,0x0aea6,6], [1961,0x0ab50,0], [1962,0x04b60,4], [1963,0x0aae4,0], [1964,0x0a570,0],
            [1965,0x05260,2], [1966,0x0f263,0], [1967,0x0d950,0], [1968,0x05b57,7], [1969,0x056a0,0],
            [1970,0x096d0,0], [1971,0x04dd5,5], [1972,0x04ad0,0], [1973,0x0a4d0,3], [1974,0x0d4d4,0],
            [1975,0x0d250,0], [1976,0x0d558,8], [1977,0x0b540,0], [1978,0x0b6a0,0], [1979,0x195a6,6],
            [1980,0x095b0,0], [1981,0x049b0,4], [1982,0x0a974,0], [1983,0x0a4b0,0], [1984,0x0b27a,0],
            [1985,0x06a50,0], [1986,0x06d40,9], [1987,0x0af46,0], [1988,0x0ab60,0], [1989,0x09570,7],
            [1990,0x04af5,0], [1991,0x04970,0], [1992,0x064b0,5], [1993,0x074a3,0], [1994,0x0ea50,0],
            [1995,0x06b58,3], [1996,0x05ac0,0], [1997,0x0ab60,0], [1998,0x096d5,8], [1999,0x092e0,0],
            [2000,0x0c960,0], [2001,0x0d954,6], [2002,0x0d4a0,0], [2003,0x0da50,4], [2004,0x07552,0],
            [2005,0x056a0,0], [2006,0x0abb7,2], [2007,0x025d0,0], [2008,0x092d0,7], [2009,0x0cab5,0],
            [2010,0x0a950,0], [2011,0x0b4a0,5], [2012,0x0baa4,0], [2013,0x0ad50,0], [2014,0x055d9,0],
            [2015,0x04ba0,0], [2016,0x0a5b0,9], [2017,0x15176,0], [2018,0x052b0,0], [2019,0x0a930,7],
            [2020,0x07954,0], [2021,0x06aa0,0], [2022,0x0ad50,5], [2023,0x05b52,0], [2024,0x04b60,0],
            [2025,0x0a6e6,4], [2026,0x0a4e0,0], [2027,0x0d260,8], [2028,0x0ea65,0], [2029,0x0d530,0],
            [2030,0x05aa0,6], [2031,0x076a3,0], [2032,0x096d0,0], [2033,0x04afb,2], [2034,0x04ad0,0],
            [2035,0x0a4d0,7], [2036,0x1d0b6,0], [2037,0x0d250,0], [2038,0x0d520,5], [2039,0x0dd45,0],
            [2040,0x0b5a0,0], [2041,0x056d0,3], [2042,0x055b2,0], [2043,0x049b0,0], [2044,0x0a577,8],
            [2045,0x0a4b0,0], [2046,0x0aa50,0], [2047,0x1b255,6], [2048,0x06d20,0], [2049,0x0ada0,4],
            [2050,0x14b63,0], [2051,0x09370,0], [2052,0x049f8,2], [2053,0x04970,0], [2054,0x064b0,7],
            [2055,0x168a6,0], [2056,0x0ea50,0], [2057,0x06b20,5], [2058,0x1a6c4,0], [2059,0x0aae0,0],
            [2060,0x092e0,3], [2061,0x0d2e3,0], [2062,0x0c960,0], [2063,0x0d557,8], [2064,0x0d4a0,0],
            [2065,0x0da50,0], [2066,0x05d55,6], [2067,0x056a0,0], [2068,0x0a6d0,4], [2069,0x055d4,0],
            [2070,0x052d0,0], [2071,0x0a9b8,2], [2072,0x0a950,0], [2073,0x0b4a0,7], [2074,0x0b6a6,0],
            [2075,0x0ad50,0], [2076,0x055a0,5], [2077,0x0aba4,0], [2078,0x0a5b0,0], [2079,0x052b0,3],
            [2080,0x0b273,0], [2081,0x06930,0], [2082,0x07337,8], [2083,0x06aa0,0], [2084,0x0ad50,0],
            [2085,0x14b55,6], [2086,0x04b60,0], [2087,0x0a570,4], [2088,0x054e4,0], [2089,0x0d160,0],
            [2090,0x0e968,2], [2091,0x0d520,0], [2092,0x0daa0,7], [2093,0x16aa6,0], [2094,0x056d0,0],
            [2095,0x04ae0,5], [2096,0x0a9d4,0], [2097,0x0a2d0,0], [2098,0x0d150,3], [2099,0x0f252,0],
            [2100,0x0d520,0]
        ];

        // Show/hide leap month checkbox based on calendar type
        document.querySelectorAll('input[name="calendarType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const leapMonthDiv = document.getElementById('leapMonthDiv');
                leapMonthDiv.style.display = this.value === 'lunar' ? 'block' : 'none';
            });
        });

        function showError(message) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => errorDiv.classList.remove('show'), 5000);
        }

        function hideError() {
            document.getElementById('errorMsg').classList.remove('show');
        }

        function getLunarMonthDays(year, month, lunarData) {
            const yearData = lunarData.find(d => d[0] === year);
            if (!yearData) return 29;
            const monthDaysBits = yearData[1];
            return (monthDaysBits & (1 << (12 - month))) ? 30 : 29;
        }

        function getLeapMonth(year, lunarData) {
            const yearData = lunarData.find(d => d[0] === year);
            return yearData ? yearData[2] : 0;
        }

        // Convert lunar to solar date
        function lunarToSolar(lunarYear, lunarMonth, lunarDay, isLeapMonth) {
            if (lunarYear < 1900 || lunarYear > 2100) {
                throw new Error('Year must be between 1900 and 2100');
            }

            // Calculate days from base date (1900-01-31 = Lunar 1900-01-01)
            let offset = 0;
            const baseDate = new Date(1900, 0, 31); // Jan 31, 1900

            for (let year = 1900; year < lunarYear; year++) {
                const leapMonth = getLeapMonth(year, LUNAR_DATA);
                for (let month = 1; month <= 12; month++) {
                    offset += getLunarMonthDays(year, month, LUNAR_DATA);
                }
                if (leapMonth > 0) {
                    offset += getLunarMonthDays(year, leapMonth, LUNAR_DATA);
                }
            }

            const currentLeapMonth = getLeapMonth(lunarYear, LUNAR_DATA);
            for (let month = 1; month < lunarMonth; month++) {
                offset += getLunarMonthDays(lunarYear, month, LUNAR_DATA);
            }

            if (isLeapMonth && currentLeapMonth === lunarMonth) {
                offset += getLunarMonthDays(lunarYear, lunarMonth, LUNAR_DATA);
            }

            offset += lunarDay - 1;

            const solarDate = new Date(baseDate.getTime() + offset * 86400000);
            return {
                year: solarDate.getFullYear(),
                month: solarDate.getMonth() + 1,
                day: solarDate.getDate()
            };
        }

        // Convert solar to lunar date (simplified version)
        function solarToLunar(solarYear, solarMonth, solarDay) {
            const solarDate = new Date(solarYear, solarMonth - 1, solarDay);
            const baseDate = new Date(1900, 0, 31);
            let offset = Math.floor((solarDate - baseDate) / 86400000);

            let lunarYear = 1900;
            let daysInYear = 0;

            while (lunarYear < 2101 && offset > 0) {
                daysInYear = 0;
                const leapMonth = getLeapMonth(lunarYear, LUNAR_DATA);
                for (let month = 1; month <= 12; month++) {
                    daysInYear += getLunarMonthDays(lunarYear, month, LUNAR_DATA);
                }
                if (leapMonth > 0) {
                    daysInYear += getLunarMonthDays(lunarYear, leapMonth, LUNAR_DATA);
                }

                if (offset < daysInYear) break;
                offset -= daysInYear;
                lunarYear++;
            }

            let lunarMonth = 1;
            let isLeapMonth = false;
            const currentLeapMonth = getLeapMonth(lunarYear, LUNAR_DATA);

            while (lunarMonth <= 12 && offset > 0) {
                const daysInMonth = getLunarMonthDays(lunarYear, lunarMonth, LUNAR_DATA);
                if (offset < daysInMonth) break;
                offset -= daysInMonth;

                if (currentLeapMonth === lunarMonth && !isLeapMonth) {
                    const leapDays = getLunarMonthDays(lunarYear, currentLeapMonth, LUNAR_DATA);
                    if (offset < leapDays) {
                        isLeapMonth = true;
                        break;
                    }
                    offset -= leapDays;
                }
                lunarMonth++;
            }

            return {
                year: lunarYear,
                month: lunarMonth,
                day: offset + 1,
                isLeapMonth: isLeapMonth
            };
        }

        // Calculate solar term dates (24ì ˆê¸°)
        // Simplified calculation based on approximate dates
        function getSolarTermDate(year, termIndex) {
            // Base dates for solar terms (month-1, day)
            const solarTerms = [
                [1, 4],  // 0: Lichun ì…ì¶˜ (Start of Spring) - around Feb 4
                [1, 19], // 1: Yushui ìš°ìˆ˜ (Rain Water)
                [2, 6],  // 2: Jingzhe ê²½ì¹© (Awakening of Insects) - around Mar 6
                [2, 21], // 3: Chunfen ì¶˜ë¶„ (Spring Equinox)
                [3, 5],  // 4: Qingming ì²­ëª… (Pure Brightness) - around Apr 5
                [3, 20], // 5: Guyu ê³¡ìš° (Grain Rain)
                [4, 5],  // 6: Lixia ì…í•˜ (Start of Summer) - around May 5
                [4, 21], // 7: Xiaoman ì†Œë§Œ (Grain Buds)
                [5, 6],  // 8: Mangzhong ë§ì¢… (Grain in Ear) - around Jun 6
                [5, 21], // 9: Xiazhi í•˜ì§€ (Summer Solstice)
                [6, 7],  // 10: Xiaoshu ì†Œì„œ (Slight Heat) - around Jul 7
                [6, 23], // 11: Dashu ëŒ€ì„œ (Great Heat)
                [7, 7],  // 12: Liqiu ì…ì¶” (Start of Autumn) - around Aug 7
                [7, 23], // 13: Chushu ì²˜ì„œ (End of Heat)
                [8, 8],  // 14: Bailu ë°±ë¡œ (White Dew) - around Sep 8
                [8, 23], // 15: Qiufen ì¶”ë¶„ (Autumn Equinox)
                [9, 8],  // 16: Hanlu í•œë¡œ (Cold Dew) - around Oct 8
                [9, 23], // 17: Shuangjiang ìƒê°• (Descent of Frost)
                [10, 7], // 18: Lidong ì…ë™ (Start of Winter) - around Nov 7
                [10, 22],// 19: Xiaoxue ì†Œì„¤ (Slight Snow)
                [11, 7], // 20: Daxue ëŒ€ì„¤ (Great Snow) - around Dec 7
                [11, 22],// 21: Dongzhi ë™ì§€ (Winter Solstice)
                [0, 6],  // 22: Xiaohan ì†Œí•œ (Slight Cold) - around Jan 6
                [0, 20]  // 23: Dahan ëŒ€í•œ (Great Cold)
            ];

            const [month, day] = solarTerms[termIndex];
            return new Date(year, month, day);
        }

        // Get 60 Jiazi (sexagenary cycle) combination
        function getJiazi(index) {
            const stemIndex = index % 10;
            const branchIndex = index % 12;
            return {
                stem: HEAVENLY_STEMS[stemIndex],
                branch: EARTHLY_BRANCHES[branchIndex]
            };
        }

        // Calculate year pillar based on Lichun
        function getYearPillar(year, month, day) {
            // Check if before Lichun
            const lichunDate = getSolarTermDate(year, 0); // Lichun is index 0
            const currentDate = new Date(year, month - 1, day);

            let astroYear = year;
            if (currentDate < lichunDate) {
                astroYear = year - 1;
            }

            // Year 4 (Jiazi year) corresponds to stem-branch cycle start
            // Year 1984 was ç”²å­ (Jiazi) year
            const offset = (astroYear - 1984 + 60) % 60;
            return getJiazi(offset);
        }

        // Calculate month pillar based on solar terms
        function getMonthPillar(year, month, day, yearStemIndex) {
            // Determine which solar term month we're in
            const currentDate = new Date(year, month - 1, day);
            
            // Find the current month branch based on solar terms
            // Month branches: ì¸(2ì›”/ì…ì¶˜~ê²½ì¹©), ë¬˜(3ì›”/ê²½ì¹©~ì²­ëª…), ì§„(4ì›”/ì²­ëª…~ì…í•˜), ...
            let monthBranchIndex = 2; // Default to å¯…(Tiger) for Lichun month
            
            // Check each solar term (every 2 terms = 1 month)
            // 0:ì…ì¶˜, 2:ê²½ì¹©, 4:ì²­ëª…, 6:ì…í•˜, 8:ë§ì¢…, 10:ì†Œì„œ, 12:ì…ì¶”, 14:ë°±ë¡œ, 16:í•œë¡œ, 18:ì…ë™, 20:ëŒ€ì„¤, 22:ì†Œí•œ
            const solarTermMonthBranches = [
                { term: 0, branch: 2 },   // ì…ì¶˜ -> ì¸ì›”(å¯…)
                { term: 2, branch: 3 },   // ê²½ì¹© -> ë¬˜ì›”(å¯)
                { term: 4, branch: 4 },   // ì²­ëª… -> ì§„ì›”(è¾°)
                { term: 6, branch: 5 },   // ì…í•˜ -> ì‚¬ì›”(å·³)
                { term: 8, branch: 6 },   // ë§ì¢… -> ì˜¤ì›”(åˆ)
                { term: 10, branch: 7 },  // ì†Œì„œ -> ë¯¸ì›”(æœª)
                { term: 12, branch: 8 },  // ì…ì¶” -> ì‹ ì›”(ç”³)
                { term: 14, branch: 9 },  // ë°±ë¡œ -> ìœ ì›”(é…‰)
                { term: 16, branch: 10 }, // í•œë¡œ -> ìˆ ì›”(æˆŒ)
                { term: 18, branch: 11 }, // ì…ë™ -> í•´ì›”(äº¥)
                { term: 20, branch: 0 },  // ëŒ€ì„¤ -> ìì›”(å­)
                { term: 22, branch: 1 }   // ì†Œí•œ -> ì¶•ì›”(ä¸‘)
            ];
            
            // Check against Lichun of current and next year
            const lichunThisYear = getSolarTermDate(year, 0);
            const lichunNextYear = getSolarTermDate(year + 1, 0);
            
            // If before this year's Lichun, we're in the previous year's last month
            if (currentDate < lichunThisYear) {
                monthBranchIndex = 1; // ì¶•ì›”(ä¸‘) - Dec-Jan period
            } else {
                // Find which solar term period we're in
                for (let i = 0; i < solarTermMonthBranches.length; i++) {
                    const { term, branch } = solarTermMonthBranches[i];
                    const termDate = getSolarTermDate(year, term);
                    const nextTermIdx = (i + 1 < solarTermMonthBranches.length) ? 
                        solarTermMonthBranches[i + 1].term : 0;
                    const nextTermDate = (i + 1 < solarTermMonthBranches.length) ?
                        getSolarTermDate(year, nextTermIdx) : lichunNextYear;
                    
                    if (currentDate >= termDate && currentDate < nextTermDate) {
                        monthBranchIndex = branch;
                        break;
                    }
                }
            }

            // Month stem calculation based on year stem (ì›”ë‘ë²•/year stem method)
            // ê°‘Â·ê¸°ë…„(0,5): ì¸ì›”=ë³‘(2), ì„Â·ê²½ë…„(1,6): ì¸ì›”=ë¬´(4), ë³‘Â·ì‹ ë…„(2,7): ì¸ì›”=ê²½(6), 
            // ì •Â·ì„ë…„(3,8): ì¸ì›”=ì„(8), ë¬´Â·ê³„ë…„(4,9): ì¸ì›”=ê°‘(0)
            const monthStemBase = [2, 4, 6, 8, 0]; // ì¸ì›”ì˜ ì²œê°„ by year stem % 5
            const baseIndex = yearStemIndex % 5; // Map year stem to one of 5 groups
            const inMonthStem = monthStemBase[baseIndex]; // ì¸ì›”(å¯…æœˆ)ì˜ ì²œê°„
            
            // Calculate month stem from ì¸ì›” base
            // ì¸=2, so offset from ì¸ì›” to current month
            const monthOffset = (monthBranchIndex - 2 + 12) % 12;
            const monthStemIndex = (inMonthStem + monthOffset) % 10;

            return {
                stem: HEAVENLY_STEMS[monthStemIndex],
                branch: EARTHLY_BRANCHES[monthBranchIndex]
            };
        }

        // Calculate day pillar
        function getDayPillar(year, month, day) {
            // Use Julian Day Number method
            // Reference day: 1900-01-01 = ê°‘ìˆ  (ç”²æˆŒ) in 60-day cycle
            const baseDate = new Date(1900, 0, 1);
            const currentDate = new Date(year, month - 1, day);
            const daysDiff = Math.floor((currentDate - baseDate) / 86400000);
            
            // 1900-01-01 is ê°‘ìˆ (ç”²æˆŒ) which is index 10 in 60 Jiazi cycle
            const offset = (daysDiff + 10) % 60;
            return getJiazi(offset);
        }

        // Calculate hour pillar
        function getHourPillar(hour, minute, dayStemIndex) {
            // Determine hour branch (12 double-hours)
            // 23:00-01:00 = å­æ™‚, 01:00-03:00 = ä¸‘æ™‚, etc.
            let adjustedHour = hour;
            
            // Handle 23:00-24:00 as next day's å­æ™‚
            if (hour === 23) {
                adjustedHour = 0; // Treat as å­æ™‚ of next day
            }

            const hourBranchIndex = Math.floor((adjustedHour + 1) / 2) % 12;

            // Hour stem calculation based on day stem
            // Formula: hour_stem = (day_stem * 2 + hour_branch) % 10
            const hourStemIndex = (dayStemIndex * 2 + hourBranchIndex) % 10;

            return {
                stem: HEAVENLY_STEMS[hourStemIndex],
                branch: EARTHLY_BRANCHES[hourBranchIndex]
            };
        }

        function formatPillar(pillar) {
            return `
                <div class="pillar-chinese">${pillar.stem.ch}${pillar.branch.ch}</div>
                <div class="pillar-korean">${pillar.stem.ko}${pillar.branch.ko}</div>
                <div class="element-info">${pillar.stem.element}</div>
                <div class="element-info">${pillar.branch.element} (${pillar.branch.animal})</div>
            `;
        }

        function calculateSaju() {
            hideError();

            try {
                // Get input values
                const calendarType = document.querySelector('input[name="calendarType"]:checked').value;
                let year = parseInt(document.getElementById('year').value);
                let month = parseInt(document.getElementById('month').value);
                let day = parseInt(document.getElementById('day').value);
                const hour = parseInt(document.getElementById('hour').value) || 0;
                const minute = parseInt(document.getElementById('minute').value) || 0;
                const isLeapMonth = document.getElementById('isLeapMonth').checked;

                // Validation
                if (!year || !month || !day) {
                    showError('ìƒë…„ì›”ì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (year < 1900 || year > 2100) {
                    showError('ë…„ë„ëŠ” 1900-2100 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }

                if (month < 1 || month > 12) {
                    showError('ì›”ì€ 1-12 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }

                if (day < 1 || day > 31) {
                    showError('ì¼ì€ 1-31 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }

                let solarYear = year;
                let solarMonth = month;
                let solarDay = day;
                let displayDate = '';

                // Convert lunar to solar if needed
                if (calendarType === 'lunar') {
                    const solar = lunarToSolar(year, month, day, isLeapMonth);
                    solarYear = solar.year;
                    solarMonth = solar.month;
                    solarDay = solar.day;
                    displayDate = `ìŒë ¥ ${year}ë…„ ${month}ì›” ${day}ì¼${isLeapMonth ? '(ìœ¤)' : ''} â†’ ì–‘ë ¥ ${solarYear}ë…„ ${solarMonth}ì›” ${solarDay}ì¼`;
                } else {
                    const lunar = solarToLunar(year, month, day);
                    displayDate = `ì–‘ë ¥ ${year}ë…„ ${month}ì›” ${day}ì¼ â†’ ìŒë ¥ ${lunar.year}ë…„ ${lunar.month}ì›” ${lunar.day}ì¼${lunar.isLeapMonth ? '(ìœ¤)' : ''}`;
                }

                // Calculate pillars
                const yearPillar = getYearPillar(solarYear, solarMonth, solarDay);
                const monthPillar = getMonthPillar(solarYear, solarMonth, solarDay, 
                    HEAVENLY_STEMS.findIndex(s => s.ch === yearPillar.stem.ch));
                const dayPillar = getDayPillar(solarYear, solarMonth, solarDay);
                const hourPillar = getHourPillar(hour, minute,
                    HEAVENLY_STEMS.findIndex(s => s.ch === dayPillar.stem.ch));

                // Display results
                document.getElementById('convertedDate').innerHTML = `<strong>ë³€í™˜ ì •ë³´:</strong> ${displayDate}<br><strong>ì‹œê°„:</strong> ${hour}ì‹œ ${minute}ë¶„`;
                document.getElementById('yearPillar').innerHTML = formatPillar(yearPillar);
                document.getElementById('monthPillar').innerHTML = formatPillar(monthPillar);
                document.getElementById('dayPillar').innerHTML = formatPillar(dayPillar);
                document.getElementById('hourPillar').innerHTML = formatPillar(hourPillar);

                // Display element information
                const elementInfo = `
                    <h3>ğŸŒŸ ì˜¤í–‰ ì •ë³´ (Five Elements)</h3>
                    <p><strong>ì¼ê°„ (æ—¥å¹², Day Master):</strong> ${dayPillar.stem.ch}${dayPillar.stem.ko} - ${dayPillar.stem.element}</p>
                    <p>ì¼ê°„ì€ ë³¸ì¸ì„ ë‚˜íƒ€ë‚´ë©°, ì‚¬ì£¼íŒ”ì í•´ì„ì˜ ì¤‘ì‹¬ì´ ë©ë‹ˆë‹¤.</p>
                    <p><strong>ì‚¬ì£¼ êµ¬ì„±:</strong></p>
                    <ul>
                        <li>ì—°ì£¼ ${yearPillar.stem.ch}${yearPillar.branch.ch} - ì¡°ìƒ, ì´ˆë…„ìš´ (0-20ì„¸)</li>
                        <li>ì›”ì£¼ ${monthPillar.stem.ch}${monthPillar.branch.ch} - ë¶€ëª¨, ì²­ë…„ìš´ (20-40ì„¸)</li>
                        <li>ì¼ì£¼ ${dayPillar.stem.ch}${dayPillar.branch.ch} - ë³¸ì¸/ë°°ìš°ì, ì¤‘ë…„ìš´ (40-60ì„¸)</li>
                        <li>ì‹œì£¼ ${hourPillar.stem.ch}${hourPillar.branch.ch} - ìë…€, ë§ë…„ìš´ (60ì„¸ ì´í›„)</li>
                    </ul>
                `;
                document.getElementById('elementInfo').innerHTML = elementInfo;

                document.getElementById('resultSection').classList.add('show');
                document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                showError('ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                console.error(error);
            }
        }

        // Test function for validation
        function runTest() {
            // Test case: 1992-10-24 05:30
            document.querySelector('input[value="solar"]').checked = true;
            document.getElementById('year').value = 1992;
            document.getElementById('month').value = 10;
            document.getElementById('day').value = 24;
            document.getElementById('hour').value = 5;
            document.getElementById('minute').value = 30;
            calculateSaju();
        }

        // Enable Enter key to calculate
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculateSaju();
            }
        });
    </script>
</body>
</html>
